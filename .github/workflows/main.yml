name: Build & Push qBittorrent Custom

on:
  push:
    branches: [ "main" ]
  schedule:
    # 02:00 UTC = 03:00 AM EspaÃ±a (Invierno) / 04:00 AM (Verano)
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: erchache2000/qbittorrent-py
  GHCR_IMAGE_NAME: ghcr.io/${{ github.repository }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  # TRABAJO 1: VerificaciÃ³n de cambios en upstream
  check:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check_decision.outputs.should_build }}
      base_digest: ${{ steps.get_digest.outputs.digest }}
    steps:
      - name: âš™ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Obtener Imagen Base y Digest Remoto
        id: get_digest
        run: |
          BASE_IMAGE=$(grep -m 1 '^FROM' Dockerfile | awk '{print $2}')
          echo "Imagen base detectada: $BASE_IMAGE"
          DIGEST=$(skopeo inspect docker://$BASE_IMAGE --format '{{.Digest}}')
          echo "Digest remoto actual: $DIGEST"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: ğŸ”’ Login para skopeo en GHCR
        run: |
          echo "${{ secrets.GHCR_TAG }}" | skopeo login ghcr.io --username ${{ github.actor }} --password-stdin

      - name: ğŸ§  Decidir si construir
        id: check_decision
        env:
          GH_REGISTRY: ${{ env.GHCR_IMAGE_NAME }}:latest
        run: |
          if [[ "${{ github.event_name }}" != "schedule" ]]; then
            echo "Evento manual o push. Forzando construcciÃ³n."
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Evento programado. Verificando si la base ha cambiado..."
          LAST_BASE_DIGEST=$(skopeo inspect --creds "${{ github.actor }}:${{ secrets.GHCR_TAG }}" docker://$GH_REGISTRY --format '{{.Labels.base_image_digest}}' || echo "none")
          CURRENT_BASE_DIGEST="${{ steps.get_digest.outputs.digest }}"

          echo "Ãšltimo digest en GHCR: $LAST_BASE_DIGEST"
          echo "Digest actual de la base: $CURRENT_BASE_DIGEST"

          if [[ "$LAST_BASE_DIGEST" == "$CURRENT_BASE_DIGEST" ]]; then
            echo "ğŸ›‘ La imagen base no ha cambiado. Saltando build."
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸš€ Nueva imagen base detectada. Construyendo actualizaciÃ³n."
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  # TRABAJO 2: Construir y Subir (Solo si check es true)
  build-and-push:
    needs: check
    if: needs.check.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: âš™ï¸ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”’ Login en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ”’ Login en GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TAG }}

      - name: ğŸ·ï¸ Definir Tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKER_IMAGE_NAME }}
            ${{ env.GHCR_IMAGE_NAME }}
          tags: |
            type=schedule,pattern={{date 'YYYYMMDD'}}
            type=raw,value=latest
            type=sha,format=short

      - name: ğŸ—ï¸ Construir y Subir
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          pull: true
          tags: ${{ steps.meta.outputs.tags }}
          platforms: linux/amd64
          labels: |
            ${{ steps.meta.outputs.labels }}
            base_image_digest=${{ needs.check.outputs.base_digest }}
